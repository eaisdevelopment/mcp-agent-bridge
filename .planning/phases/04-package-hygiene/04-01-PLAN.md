---
phase: 04-package-hygiene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/index.ts
  - src/constants.ts
autonomous: true

must_haves:
  truths:
    - "package.json has bin, files, prepublishOnly, keywords, repository, homepage, bugs fields"
    - "Version is 0.1.0 in package.json and single-sourced to constants.ts via createRequire"
    - "src/index.ts has #!/usr/bin/env node shebang as very first line"
    - "dist/index.js has shebang preserved after build"
  artifacts:
    - path: "package.json"
      provides: "npm packaging metadata"
      contains: "\"bin\""
    - path: "src/index.ts"
      provides: "CLI entry point with shebang"
      contains: "#!/usr/bin/env node"
    - path: "src/constants.ts"
      provides: "Single-sourced version from package.json"
      contains: "createRequire"
  key_links:
    - from: "src/constants.ts"
      to: "package.json"
      via: "createRequire reads version at runtime"
      pattern: "createRequire.*package\\.json"
    - from: "package.json bin"
      to: "dist/index.js"
      via: "bin field points to compiled entry"
      pattern: "\"dist/index.js\""
---

<objective>
Add npm packaging fields to package.json, shebang to src/index.ts, and single-source the version from package.json via createRequire.

Purpose: Make the package publishable to npm with correct CLI binary support, discoverable metadata, and no version drift between package.json and runtime constants.
Output: Updated package.json, src/index.ts with shebang, src/constants.ts reading version from package.json.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-package-hygiene/04-RESEARCH.md

@package.json
@src/index.ts
@src/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add npm packaging fields to package.json and shebang to src/index.ts</name>
  <files>package.json, src/index.ts</files>
  <action>
Update package.json with these fields (preserve all existing fields):

1. Change `"version"` from `"1.0.0"` to `"0.1.0"` (PKG-09)
2. Add `"bin"` field: `{ "cc-bridge-mcp-server": "dist/index.js" }` (PKG-01)
3. Add `"files"` field: `["dist", "README.md", "LICENSE"]` (PKG-03)
4. Add to scripts: `"prepublishOnly": "npm run build"` (PKG-04)
5. Add `"keywords"`: `["mcp", "model-context-protocol", "claude", "claude-code", "bridge", "inter-session", "communication", "ai", "agent"]` (PKG-07)
6. Add `"repository"`: `{ "type": "git", "url": "https://github.com/OWNER/cc-bridge-mcp-server.git" }` (PKG-08, placeholder URL)
7. Add `"homepage"`: `"https://github.com/OWNER/cc-bridge-mcp-server#readme"` (PKG-08)
8. Add `"bugs"`: `{ "url": "https://github.com/OWNER/cc-bridge-mcp-server/issues" }` (PKG-08)
9. Add `"license"`: `"ISC"` (aligns with LICENSE file in plan 02)

NOTE: Use `OWNER` as placeholder in URLs since no git remote is configured. User will update before actual npm publish.

For src/index.ts: Add `#!/usr/bin/env node` as the very first line of the file, before any imports. This is critical -- the shebang MUST be line 1. TypeScript's tsc preserves shebangs when they are the first line.
  </action>
  <verify>
Run: `node -e "const p = require('./package.json'); console.log(p.version, !!p.bin, !!p.files, !!p.keywords, !!p.repository, !!p.homepage, !!p.bugs, p.scripts.prepublishOnly)"`
Expected: `0.1.0 true true true true true true npm run build`

Run: `head -1 src/index.ts`
Expected: `#!/usr/bin/env node`
  </verify>
  <done>package.json has all required fields (bin, files, prepublishOnly, keywords, repository, homepage, bugs, license) with version 0.1.0. src/index.ts has shebang as first line.</done>
</task>

<task type="auto">
  <name>Task 2: Single-source version from package.json in constants.ts</name>
  <files>src/constants.ts</files>
  <action>
Replace the hardcoded `SERVER_VERSION = "1.0.0"` in src/constants.ts with a dynamic read from package.json using `createRequire`.

New contents of src/constants.ts:
```typescript
import { createRequire } from "node:module";

const require = createRequire(import.meta.url);
const pkg = require("../package.json") as { version: string };

export const SERVER_NAME = "cc-bridge-mcp-server";
export const SERVER_VERSION = pkg.version;
```

Why createRequire instead of import assertion: TypeScript 5.7+ has a regression with JSON imports under `module: "Node16"` (TS issue #60589). `createRequire` is the reliable standard pattern.

After writing, run `npm run build` and verify:
1. `dist/index.js` starts with `#!/usr/bin/env node`
2. `dist/constants.js` contains `createRequire`
3. The server reports the correct version: `node -e "import('./dist/constants.js').then(m => console.log(m.SERVER_VERSION))"`
4. `npm test` still passes (existing tests reference SERVER_VERSION)
  </action>
  <verify>
Run: `npm run build` -- must succeed
Run: `head -1 dist/index.js` -- must show `#!/usr/bin/env node`
Run: `node -e "import('./dist/constants.js').then(m => console.log(m.SERVER_VERSION))"` -- must print `0.1.0`
Run: `npm test` -- all tests must pass
  </verify>
  <done>constants.ts reads version from package.json via createRequire. Build succeeds. dist/index.js has shebang. Runtime version is 0.1.0. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. `head -1 dist/index.js` shows `#!/usr/bin/env node`
3. `node -e "import('./dist/constants.js').then(m => console.log(m.SERVER_VERSION))"` prints `0.1.0`
4. `npm test` passes -- no regressions
5. package.json contains all 9 required fields (bin, files, prepublishOnly, keywords, repository, homepage, bugs, license, version 0.1.0)
</verification>

<success_criteria>
- package.json has bin pointing to dist/index.js, files whitelist, prepublishOnly script, keywords array, repository/homepage/bugs URLs, license ISC, version 0.1.0
- src/index.ts has #!/usr/bin/env node as first line
- src/constants.ts reads version from package.json using createRequire (no hardcoded version string)
- Build produces dist/index.js with shebang preserved
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-package-hygiene/04-01-SUMMARY.md`
</output>
