---
phase: 03-health-stale-peers
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/config.ts
  - src/types.ts
  - src/services/peer-registry.ts
  - src/tools/list-peers.ts
  - src/tools/send-message.ts
  - src/services/peer-registry.test.ts
  - src/tools/list-peers.test.ts
  - src/tools/send-message.test.ts
autonomous: true

must_haves:
  truths:
    - "Calling cc_list_peers when a peer has been registered but idle beyond the stale timeout flags that peer as potentiallyStale"
    - "Peers that have interacted recently (register, send, receive) are NOT flagged as stale"
    - "Existing state files without lastSeenAt field are handled gracefully (backward compatible)"
    - "Stale timeout is configurable via CC_BRIDGE_STALE_TIMEOUT_MS environment variable"
  artifacts:
    - path: "src/config.ts"
      provides: "CC_BRIDGE_STALE_TIMEOUT_MS config field"
      contains: "CC_BRIDGE_STALE_TIMEOUT_MS"
    - path: "src/types.ts"
      provides: "lastSeenAt field on PeerInfo"
      contains: "lastSeenAt"
    - path: "src/services/peer-registry.ts"
      provides: "lastSeenAt updates on register, listPeers with stale flag"
      exports: ["registerPeer", "listPeers"]
    - path: "src/tools/list-peers.ts"
      provides: "stale flag in list-peers MCP response"
      contains: "potentiallyStale"
    - path: "src/tools/send-message.ts"
      provides: "lastSeenAt updates for sender and target on successful delivery"
      contains: "lastSeenAt"
  key_links:
    - from: "src/services/peer-registry.ts"
      to: "src/config.ts"
      via: "getConfig().CC_BRIDGE_STALE_TIMEOUT_MS for stale computation"
      pattern: "CC_BRIDGE_STALE_TIMEOUT_MS"
    - from: "src/tools/list-peers.ts"
      to: "src/services/peer-registry.ts"
      via: "listPeers() returns PeerInfo[] with lastSeenAt"
      pattern: "listPeers"
    - from: "src/tools/send-message.ts"
      to: "src/services/peer-registry.ts"
      via: "updateLastSeen() after successful CLI exec"
      pattern: "updateLastSeen"
---

<objective>
Add stale peer detection to cc_list_peers and lastSeenAt tracking across peer interactions. Peers idle beyond a configurable timeout are flagged as potentiallyStale in list-peers output.

Purpose: Users can see which peers may need re-registration, avoiding confusion from stale entries. Covers requirements PEER-01, PEER-02.
Output: Config extension, PeerInfo type update, peer-registry lastSeenAt tracking, list-peers stale flag, send-message lastSeenAt updates, tests.
</objective>

<execution_context>
@/Users/dev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-health-stale-peers/03-RESEARCH.md
@.planning/phases/03-health-stale-peers/03-01-SUMMARY.md

@src/config.ts
@src/types.ts
@src/services/peer-registry.ts
@src/tools/list-peers.ts
@src/tools/send-message.ts
@src/tools/register-peer.ts
@src/errors.ts
@src/test-helpers.ts
@src/services/peer-registry.test.ts
@src/tools/list-peers.test.ts
@src/tools/send-message.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add lastSeenAt tracking and stale detection to services and tools</name>
  <files>
    src/config.ts
    src/types.ts
    src/services/peer-registry.ts
    src/tools/list-peers.ts
    src/tools/send-message.ts
  </files>
  <action>
**src/config.ts** -- Add stale timeout config:
- Add to `configSchema`: `CC_BRIDGE_STALE_TIMEOUT_MS: z.coerce.number().int().min(0).default(1_800_000)` (30 minutes default). Min 0 allows disabling stale detection (0 = never stale).
- This extends the existing Config type automatically via z.infer.

**src/types.ts** -- Add lastSeenAt to PeerInfo:
- Add `lastSeenAt: string;` field to PeerInfo interface (after registeredAt).

**src/services/peer-registry.ts** -- Three changes:

1. In `registerPeer()`: Set `lastSeenAt: new Date().toISOString()` on the peer object alongside `registeredAt`. This is the initial "seen" timestamp.

2. Add new exported function `updateLastSeen(peerId: string): Promise<void>`:
   ```typescript
   export async function updateLastSeen(peerId: string): Promise<void> {
     return withLock(async () => {
       const state = await readState();
       const peer = state.peers[peerId];
       if (peer) {
         peer.lastSeenAt = new Date().toISOString();
         await writeState(state);
       }
     });
   }
   ```
   This is called from send-message after successful delivery.

3. Add backward-compatibility in `readState()`: After parsing state, migrate any peers missing `lastSeenAt` by defaulting to `registeredAt`. Add a helper:
   ```typescript
   function migrateState(state: BridgeState): BridgeState {
     for (const peer of Object.values(state.peers)) {
       if (!peer.lastSeenAt) {
         peer.lastSeenAt = peer.registeredAt;
       }
     }
     return state;
   }
   ```
   Call `migrateState(state)` before returning from readState() (in the success path after JSON.parse, and after emptyState() returns).

**src/tools/list-peers.ts** -- Add stale flag computation:
- Import `getConfig` from `../config.js`
- After calling `listPeers()`, compute staleness for each peer:
  ```typescript
  const staleTimeout = getConfig().CC_BRIDGE_STALE_TIMEOUT_MS;
  const now = Date.now();
  const enriched = peers.map(peer => ({
    ...peer,
    potentiallyStale: staleTimeout > 0 && (now - new Date(peer.lastSeenAt).getTime()) > staleTimeout,
  }));
  ```
- Return `successResult({ peers: enriched, count: enriched.length })` instead of raw peers.
- Update description to mention stale detection: "List all currently registered Claude Code peers on the bridge. Returns peer IDs, session IDs, working directories, labels, and flags peers as potentially stale if idle beyond the configured timeout."

**src/tools/send-message.ts** -- Update lastSeenAt on interaction:
- Import `updateLastSeen` from `../services/peer-registry.js`
- After successful CLI exec (where `success === true`), call `await updateLastSeen(fromPeerId)` and `await updateLastSeen(toPeerId)`. Do NOT update on failure (failed delivery doesn't confirm target is reachable, per research recommendation).
- Also update sender's lastSeenAt even on CLI failure -- the sender IS active since they initiated the send. Move `await updateLastSeen(fromPeerId)` to before the success check, right after `const durationMs = Date.now() - startMs;`.
- Wrap updateLastSeen calls in try/catch to prevent lastSeenAt update failures from breaking send-message. Log errors with `logger.error("Failed to update lastSeenAt", { error: err })`.

Ordering of changes:
```
// After const result = await execClaude(...)
const durationMs = Date.now() - startMs;
const success = result.exitCode === 0;

// Update sender lastSeenAt (sender is always active)
try { await updateLastSeen(fromPeerId); } catch (e) {
  logger.error("Failed to update lastSeenAt for sender", { error: e });
}

// Update target lastSeenAt only on success
if (success) {
  try { await updateLastSeen(toPeerId); } catch (e) {
    logger.error("Failed to update lastSeenAt for target", { error: e });
  }
}

await recordMessage({ ... });
```
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Run `npm test` -- existing tests pass. Some existing peer-registry tests may need the `lastSeenAt` field added to expected objects; fix any failures by adding the field to assertions.</verify>
  <done>Config has CC_BRIDGE_STALE_TIMEOUT_MS, PeerInfo has lastSeenAt, peer-registry sets lastSeenAt on register, list-peers computes potentiallyStale flag, send-message updates lastSeenAt on interaction. Existing tests pass with minor assertion updates.</done>
</task>

<task type="auto">
  <name>Task 2: Add stale detection tests and fix existing test assertions</name>
  <files>
    src/services/peer-registry.test.ts
    src/tools/list-peers.test.ts
    src/tools/send-message.test.ts
  </files>
  <action>
**Update existing tests for lastSeenAt field:**

In `src/services/peer-registry.test.ts`:
- All tests that assert on PeerInfo objects need `lastSeenAt` in expected values. The value should be an ISO string (use `expect.any(String)` or `expect.stringMatching(/^\d{4}-/)`).
- Add test: "registerPeer sets lastSeenAt to registration time" -- register a peer, assert `peer.lastSeenAt` is defined and equals `peer.registeredAt` (both set at same moment, so they should be identical or very close).
- Add test: "updateLastSeen updates the lastSeenAt timestamp" -- register a peer, wait a small delay (e.g., 10ms), call `updateLastSeen(peerId)`, then `getPeer(peerId)`, assert `peer.lastSeenAt > peer.registeredAt`.
- Add test: "readState migrates peers without lastSeenAt" -- write a state file manually (using fs.writeFile to the state path) with a peer that has NO `lastSeenAt` field. Then call `listPeers()`. Assert the returned peer has `lastSeenAt` equal to its `registeredAt`.

In `src/tools/list-peers.test.ts`:
- Existing test assertions may need updating for the enriched response shape (peers now have `potentiallyStale` field).
- Add test: "flags stale peers" -- register a peer (which sets lastSeenAt to now). Then manually modify test config with a very short stale timeout. The simplest approach: use `resetConfig()` + `loadConfig()` with `CC_BRIDGE_STALE_TIMEOUT_MS: "1"` (1ms). Wait 10ms, then call `cc_list_peers`. Parse response, assert the peer has `potentiallyStale: true`.
- Add test: "does not flag recent peers" -- register a peer, immediately call `cc_list_peers` (default 30min timeout). Assert `potentiallyStale: false`.
- Add test: "stale detection disabled when timeout is 0" -- loadConfig with `CC_BRIDGE_STALE_TIMEOUT_MS: "0"`. Register peer, wait, call list. Assert `potentiallyStale: false` regardless.

In `src/tools/send-message.test.ts`:
- Add test: "updates sender lastSeenAt after successful send" -- register two peers, send a message (mock execFile success), then call listPeers or getPeer. Assert sender's `lastSeenAt` is later than `registeredAt`.
- Add test: "updates target lastSeenAt after successful send" -- same setup, assert target's `lastSeenAt` is later than `registeredAt`.
- Add test: "does not update target lastSeenAt on failed send" -- mock execFile to return non-zero exit code. After send, assert target's `lastSeenAt` equals `registeredAt` (unchanged). Sender's should still be updated.

For the list-peers stale timeout tests, use `createTestConfig` as base then `resetConfig()` + `loadConfig()` with custom `CC_BRIDGE_STALE_TIMEOUT_MS` within the test. Or better: modify `createTestConfig` to accept optional overrides -- but don't modify test-helpers.ts (it's not in our files_modified). Instead, in the test:
```typescript
// After initial createTestConfig
resetConfig();
loadConfig({
  CC_BRIDGE_STATE_PATH: tempDir,  // reuse same temp dir
  CC_BRIDGE_STALE_TIMEOUT_MS: "1",
  CC_BRIDGE_LOG_LEVEL: "error",
  CC_BRIDGE_TIMEOUT_MS: "5000",
  CC_BRIDGE_CHAR_LIMIT: "0",
  CC_BRIDGE_CLAUDE_PATH: "claude",
});
```
  </action>
  <verify>Run `npm test` -- all tests pass including new stale detection tests. Run `npm test -- --coverage` to confirm peer-registry, list-peers, send-message maintain or improve coverage.</verify>
  <done>Stale detection tests verify: peers flagged stale after timeout, recent peers not flagged, timeout=0 disables detection, sender lastSeenAt always updated on send, target lastSeenAt updated only on success, backward-compatible migration of old state files. All existing tests updated for lastSeenAt field.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors
2. `npm test` -- all tests pass (existing + new stale detection tests)
3. Verify list-peers response includes `potentiallyStale` boolean for each peer
4. Verify config includes `CC_BRIDGE_STALE_TIMEOUT_MS` with 1800000 default
5. Verify backward compatibility: old state files without lastSeenAt don't crash
</verification>

<success_criteria>
- PeerInfo type includes lastSeenAt field
- CC_BRIDGE_STALE_TIMEOUT_MS config field exists with 30-minute default
- registerPeer sets lastSeenAt on registration
- send-message updates sender lastSeenAt always, target lastSeenAt only on success
- list-peers response includes potentiallyStale boolean per peer
- stale timeout of 0 disables stale detection
- Old state files without lastSeenAt are migrated to use registeredAt
- All existing tests pass with updated assertions
- New tests cover stale/non-stale/disabled scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/03-health-stale-peers/03-02-SUMMARY.md`
</output>
